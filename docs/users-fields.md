# Users 表字段前端展示和编辑需求

## 概述

本文档基于 `owlRD/db/03_users.sql` 中的 users 表结构，分析前端需要展示和编辑的字段。

**重要说明：**
- users 表是员工（Staff）使用的，**不是 PHI 敏感信息**
- 所有操作（创建、删除、编辑、只读）都需要根据 `roles/role-permissions` 权限控制
- 只有有权限的用户才能创建、编辑、删除用户

## 字段分类

### 1. 基本信息字段（展示 + 编辑）

#### 1.1 必填字段
- **`user_account`** (VARCHAR(100))
  - **展示**：✅ 用户列表、用户详情
  - **编辑**：✅ 创建用户时必填，编辑时只读（唯一索引，创建后不能修改）
  - **自己可修改**：❌ 不可修改（创建后只读）
  - **说明**：登录账号，自动转换为小写，在租户内唯一

- **`role`** (VARCHAR(50))
  - **展示**：✅ 用户列表、用户详情
  - **编辑**：✅ 创建和编辑时必填，从 roles 表下拉选择（需要管理权限）
  - **自己可修改**：❌ 自己不可修改，仅管理员可修改
  - **说明**：角色编码，对应 roles.role_code

- **`tenant_id`** (UUID)
  - **展示**：✅ 用户列表（显示机构名称）
  - **编辑**：❌ 不可编辑（由当前登录用户的 tenant_id 决定）
  - **说明**：所属机构，外键关联 tenants 表

#### 1.2 可选字段
- **`nickname`** (VARCHAR(255))
  - **展示**：✅ 用户列表、用户详情、用户头像旁显示
  - **编辑**：✅ 创建和编辑时可选
  - **自己可修改**：✅ 自己可以修改自己的昵称
  - **说明**：昵称/显示名称，用于 UI 显示

- **`email`** (VARCHAR(255))
  - **展示**：✅ 用户详情
  - **编辑**：✅ 创建和编辑时可选
  - **自己可修改**：✅ 自己可以修改自己的邮箱
  - **说明**：邮箱（用于工作联系），users 表是员工使用，不是 PHI

- **`phone`** (VARCHAR(50))
  - **展示**：✅ 用户详情
  - **编辑**：✅ 创建和编辑时可选
  - **自己可修改**：✅ 自己可以修改自己的手机号
  - **说明**：手机号（用于工作联系），users 表是员工使用，不是 PHI

- **`status`** (VARCHAR(50))
  - **展示**：✅ 用户列表（状态标签：Active/Disabled/Left）
  - **编辑**：✅ 编辑时可修改（需要管理权限）
  - **自己可修改**：❌ 自己不可修改，仅管理员可修改
  - **说明**：账号状态，默认 'active'，可选值：'active'、'disabled'、'left'

---

### 2. 密码相关功能（不涉及字段编辑）

- **重置密码功能**
  - **展示**：❌ 不展示密码字段（安全考虑）
  - **功能**：✅ 提供"重置密码"功能
  - **自己可操作**：✅ 自己可以重置自己的密码
  - **管理员可操作**：✅ 管理员可以重置任何用户的密码
  - **说明**：前端不直接操作 `password_hash` 字段，这是后台的事。前端只提供重置密码的 UI 和 API 调用

- **设置 PIN 码功能**
  - **展示**：❌ 不展示 PIN 码字段（安全考虑）
  - **功能**：✅ 提供"设置 PIN 码"功能（仅管理员）
  - **说明**：前端不直接操作 `pin_hash` 字段，这是后台的事。前端只提供设置 PIN 码的 UI 和 API 调用

---

### 3. 告警配置字段（展示 + 编辑）

- **`alarm_levels`** (VARCHAR[])
  - **展示**：✅ 用户详情（告警配置区域）
  - **编辑**：✅ 编辑时可修改（需要管理权限，多选：EMERGENCY、WARNING、ERROR）
  - **自己可修改**：❌ 自己不可修改，仅管理员可修改
  - **说明**：用户愿意接收的告警级别集合，为空表示使用系统默认

- **`alarm_channels`** (VARCHAR[])
  - **展示**：✅ 用户详情（告警配置区域）
  - **编辑**：✅ 编辑时可修改（需要管理权限，多选：APP、EMAIL、SMS 等）
  - **自己可修改**：❌ 自己不可修改，仅管理员可修改
  - **说明**：用户愿意接收的通道，短信等需在应用层结合策略控制

- **`alarm_scope`** (VARCHAR(20))
  - **展示**：✅ 用户详情（告警配置区域）
  - **编辑**：✅ 编辑时可修改（需要管理权限，单选：ALL、LOCATION-TAG、ASSIGNED_ONLY）
  - **自己可修改**：❌ 自己不可修改，仅管理员可修改
  - **说明**：接收范围，例如 'ALL'（全机构）、'LOCATION-TAG'（按地点标签）、'ASSIGNED_ONLY'（仅自己负责的住户）

---

### 4. 其他字段

- **`last_login_at`** (TIMESTAMPTZ)
  - **展示**：✅ 用户列表、用户详情（只读）
  - **编辑**：❌ 不可编辑（由系统自动更新）
  - **说明**：最后登录时间，用于会话管理

- **`tags`** (JSONB)
  - **展示**：✅ 用户详情（标签列表）
  - **编辑**：✅ 编辑时可修改（需要管理权限，多选标签，如 "NightShift"、"Group.A"、"FallsExpert"）
  - **自己可修改**：❌ 自己不可修改，仅管理员可新建/删除标签
  - **说明**：员工标签，用于分组和筛选

- **`preferences`** (JSONB)
  - **展示**：✅ 用户个人设置页面（当前用户自己的偏好）
  - **编辑**：✅ 用户个人设置页面（当前用户可编辑自己的偏好）
  - **说明**：用户偏好设置，包含 vitalFocus 等 UI 偏好
  - **注意**：管理员不应该编辑其他用户的 preferences，应该由用户自己管理

---

### 5. 系统字段（不展示，不编辑）

以下字段由系统管理，前端不需要展示或编辑：

- **`user_id`** (UUID) - 主键，系统生成
- **`user_account_hash`** (BYTEA) - 账号哈希，系统自动计算
- **`email_hash`** (BYTEA) - 邮箱哈希，系统自动计算
- **`phone_hash`** (BYTEA) - 手机号哈希，系统自动计算
- **`password_hash`** (BYTEA) - 密码哈希，系统管理，前端不直接操作
- **`pin_hash`** (BYTEA) - PIN 码哈希，系统管理，前端不直接操作

---

## 页面设计建议

### 1. 用户列表页面 (`/admin/users`)

**UI 格式：表格形式，每个 user_account 一行，使用灵活列宽**

**表格列配置（直接显示）：**

| 列名 | 说明 | 列宽配置 | 特性 |
|------|------|----------|------|
| `user_account` | 用户账号 | 灵活宽度（100-150px） | 不换行，超长省略，可点击，双击进入详情页 |
| `nickname` | 昵称 | 灵活宽度（100-150px） | 不换行，超长省略 |
| `email` | 邮箱 | 灵活宽度（150-200px） | 不换行，超长省略 |
| `phone` | 手机号 | 灵活宽度（120-150px） | 不换行，超长省略 |
| `role` | 角色 | 灵活宽度（100-150px） | 不换行，显示角色名称（非编码） |
| `status` | 状态 | 固定 80px | 标签：Active（绿色）/Disabled（红色）/Left（灰色），无边框 |
| `alarm_levels` | 告警级别 | 灵活宽度（120-180px） | 显示为标签，如 "EMERGENCY, WARNING"，支持换行 |
| `alarm_channels` | 告警通道 | 灵活宽度（120-180px） | 显示为标签，如 "APP, EMAIL"，支持换行 |
| `alarm_scope` | 告警接收范围 | 灵活宽度（120-150px） | 显示为文本，如 "ALL"、"LOCATION-TAG"、"ASSIGNED_ONLY" |
| `tags` | 员工标签 | 灵活宽度，占用剩余空间 | 显示为标签列表，支持换行 |
| Operation | 操作按钮 | 固定 280px | Edit、Disable/Enable、Delete、Reset Password，间距 20px |

**不显示的列：**
- `last_login_at` - 最后登录时间（在详情页显示）
- `tenant_id` - 机构 ID（不显示，因为当前用户只能看到自己租户的用户）

**列宽设计说明：**
- **灵活列宽**：大部分列使用灵活宽度，根据内容自动调整，但设置最小和最大宽度限制
- **固定列宽**：`status` 和 `Operation` 列使用固定宽度，确保布局稳定
- **超长处理**：短文本列（user_account、nickname、email、phone、role）使用省略号（ellipsis）
- **换行支持**：长文本列（alarm_levels、alarm_channels、tags）支持换行显示

**操作列：**
- 操作按钮（根据权限显示）：
  - 编辑（双击 user_account 也可以进入详情页）
  - 禁用/启用（需要 users.update 权限）
  - 删除（需要 users.delete 权限，仅 disabled 或 left 状态）
  - 重置密码（管理员可以重置任何用户的密码）

**顶部工具栏：**
- 搜索框（搜索 user_account、nickname、email、phone）
- 创建用户按钮（需要 users.create 权限）

**交互方式：**
- **双击 `user_account` 列**：进入用户详情/编辑页面

---

### 2. 用户详情/编辑页面

**进入方式：**
- 从用户列表页面双击 `user_account` 进入
- 从用户列表页面点击"编辑"按钮进入

**基本信息区域：**
- `user_account` - 用户账号（编辑时只读，显示在标题位置）
- `nickname` - 昵称（可编辑，自己可修改）
- `email` - 邮箱（可编辑，自己可修改）
- `phone` - 手机号（可编辑，自己可修改）
- `role` - 角色（下拉选择，仅管理员可编辑）
- `status` - 状态（下拉选择，仅管理员可编辑）

**告警配置区域：**
- `alarm_levels` - 告警级别（多选，仅管理员可编辑）
- `alarm_channels` - 告警通道（多选，仅管理员可编辑）
- `alarm_scope` - 接收范围（单选，仅管理员可编辑）

**其他信息区域：**
- `tags` - 员工标签（多选标签，仅管理员可新建/删除）
- `last_login_at` - 最后登录时间（只读，在详情页显示）

**操作按钮：**
- 保存（根据权限显示/隐藏）
- 取消
- 重置密码（自己可以重置自己的密码，管理员可以重置任何用户的密码）
- 设置 PIN 码（仅管理员）

**权限提示：**
- 如果当前用户是查看自己的信息，某些字段（role、status、alarm_levels、alarm_channels、alarm_scope、tags）应该只读并显示提示："此字段仅管理员可修改"

---

### 3. 用户个人设置页面 (`/user/settings`)

**展示和编辑字段：**
- `nickname` - 昵称（自己可修改）
- `email` - 邮箱（自己可修改）
- `phone` - 手机号（自己可修改）
- `preferences` - 用户偏好设置
  - `vitalFocus.selectedCardIds` - Vital Focus 页面选中的卡片
  - 其他用户偏好

**操作按钮：**
- 保存
- 重置密码（自己可以重置自己的密码）

**注意**：
- 此页面只能编辑当前登录用户自己的信息
- 不能编辑 role、status、alarm_levels、alarm_channels、alarm_scope、tags 等需要管理权限的字段
- 用户可以重置自己的密码，不需要管理员权限
- 重置密码功能不涉及直接操作 `password_hash` 字段，这是后台的事

---

## 权限控制

根据 `roles/role-permissions` 权限设计：

### 操作权限
- **查看用户列表**：需要 `users.read` 权限
- **创建用户**：需要 `users.create` 权限
- **编辑用户**：需要 `users.update` 权限
- **删除用户**：需要 `users.delete` 权限

### 字段编辑权限

#### 自己可以修改的字段（用户个人设置）
- `nickname` - 昵称
- `email` - 邮箱
- `phone` - 手机号
- 重置密码（自己可以重置自己的密码）

#### 自己不可修改的字段（需要管理权限）
- `user_account` - 用户账号（创建后只读）
- `role` - 角色（仅管理员可修改）
- `status` - 状态（仅管理员可修改）
- `alarm_levels` - 告警级别（仅管理员可修改）
- `alarm_channels` - 告警通道（仅管理员可修改）
- `alarm_scope` - 告警接收范围（仅管理员可修改）
- `tags` - 员工标签（仅管理员可新建/删除）

#### 只读字段
- `last_login_at` - 最后登录时间（系统自动更新）
- `tenant_id` - 机构 ID（由系统决定）

**允许访问的角色：**
根据 `role-permissions` 表中配置的权限，通常包括：
- Admin
- Director
- IT（IT Support）

---

## 安全注意事项

1. **非 PHI 信息**：
   - users 表是员工（Staff）使用的，**不是 PHI 敏感信息**
   - `email` 和 `phone` 用于工作联系，不是 PHI

2. **密码安全**：
   - 前端不展示 `password_hash` 字段（这是后台的事）
   - 前端只提供"重置密码"功能的 UI 和 API 调用
   - 密码哈希的存储和验证由后台处理

3. **账号唯一性**：
   - `user_account` 在租户内唯一，创建后不能修改
   - 编辑时该字段应该只读

4. **权限控制**：
   - 所有操作（创建、删除、编辑、只读）都需要根据 `roles/role-permissions` 权限控制
   - 只有有权限的用户才能创建、编辑、删除用户
   - 用户只能修改自己的部分字段（nickname、email、phone）
   - 用户可以重置自己的密码，不需要管理员权限
   - 管理员可以重置任何用户的密码
   - 告警相关配置（alarm_levels、alarm_channels、alarm_scope）由管理层统一管理

5. **密码和 PIN 码**：
   - 前端不直接操作 `password_hash` 和 `pin_hash` 字段，这是后台的事
   - 前端只提供"重置密码"和"设置 PIN 码"功能的 UI 和 API 调用
   - 密码哈希的存储和验证由后台处理

5. **用户偏好**：
   - `preferences` 应该由用户自己管理，管理员不应该编辑其他用户的偏好

---

## 参考文档

- 数据库表结构：`owlRD/db/03_users.sql`
- 权限设计：`docs/role-permissions-ui-design.md`
- 角色管理：`docs/roles.md`
- 状态管理：`docs/store.md`

