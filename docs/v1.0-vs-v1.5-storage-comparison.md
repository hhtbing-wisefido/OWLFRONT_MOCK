# v1.0 vs v1.5 存储策略对比

## 概述

本文档对比 v1.0 (`wisefido-frontend`) 和 v1.5 (`owlFront`) 项目中实际存储的用户信息，帮助理解差异并制定 v1.5 的存储策略。

---

## v1.0 实际存储的信息

### 1. Token 信息（localStorage/sessionStorage）

```typescript
// 存储键名
TOKEN_KEY = 'TOKEN__'
REFRESH_TOKEN_KEY = 'REFRESH_TOKEN__'

// 存储内容
accessToken: string  // Bearer token
refreshToken: string
```

**存储位置**：根据 `permissionCacheType` 配置决定（localStorage 或 sessionStorage）

---

### 2. 用户信息（USER_INFO_KEY）

```typescript
// 存储键名
USER_INFO_KEY = 'USER__INFO__'

// 存储内容（UserInfo 接口）
interface UserInfo {
  role: number                    // 角色 ID（敏感：权限信息）
  userId: string | number         // 用户 ID（非敏感）
  username: string               // 用户名（敏感：可能包含敏感信息）
  nickName: string               // 昵称（非敏感）
  phoneNumber: string            // 电话号码（敏感：PHI）
  gender: number                 // 性别（非敏感）
  status: number                 // 状态（非敏感）
  created: Date                  // 创建时间（非敏感）
  description?: string           // 描述（非敏感）
  homePath?: string              // 首页路径（非敏感）
  roles: RoleInfo[]              // 角色列表（敏感：权限信息）
}
```

**存储位置**：根据 `permissionCacheType` 配置决定（localStorage 或 sessionStorage）

**问题**：
- ❌ 存储了 `phoneNumber`（PHI，敏感信息）
- ❌ 存储了 `username`（可能包含敏感信息）
- ❌ 存储了 `role` 和 `roles`（权限信息，可能包含敏感信息）

---

### 3. 角色信息（ROLES_KEY）

```typescript
// 存储键名
ROLES_KEY = 'ROLES__KEY__'

// 存储内容
RoleEnum[]  // 角色枚举数组，例如：['admin', 'manager', 'general', 'caregiver']
```

**存储位置**：根据 `permissionCacheType` 配置决定（localStorage 或 sessionStorage）

**问题**：
- ❌ 存储了角色信息（权限信息，可能包含敏感信息）

---

### 4. 其他存储

```typescript
// 项目配置
PROJ_CFG_KEY = 'PROJ__CFG__KEY__'

// 多标签页
MULTIPLE_TABS_KEY = 'MULTIPLE_TABS__KEY__'

// 语言设置
LOCALE_KEY = 'LOCALE__'
```

---

## v1.5 推荐存储策略（HIPAA 合规）

### 1. Token 信息（localStorage）

```typescript
// 存储键名
TOKEN_KEY = 'ACCESS_TOKEN'
REFRESH_TOKEN_KEY = 'REFRESH_TOKEN'

// 存储内容
accessToken: string
refreshToken: string
```

**与 v1.0 相同**：Token 必须存储，用于认证

---

### 2. 用户信息（USER_INFO_KEY）- 仅非敏感信息

```typescript
// 存储键名
USER_INFO_KEY = 'USER_INFO'

// 存储内容（仅非敏感信息）
interface UserInfo {
  userId: string                    // 用户 ID（非敏感）✅
  userType: 'staff' | 'resident'   // 用户类型（非敏感）✅
  residentType?: 'home' | 'institution'  // Resident 子类型（非敏感）✅
  institutionId: string            // 机构 ID（非敏感）✅
  institutionName: string          // 机构名称（非敏感）✅
  domain?: string                  // 机构域名（非敏感）✅
  homePath?: string                // 首页路径（非敏感）✅
  
  // ❌ 不存储的敏感信息（v1.0 中存储了，v1.5 不存储）
  // username?: string              // 不存储（敏感）
  // phoneNumber?: string           // 不存储（PHI，敏感）
  // email?: string                 // 不存储（PHI，敏感）
  // role?: number                  // 不存储（权限信息，敏感）
  // roles?: RoleInfo[]            // 不存储（权限信息，敏感）
  // nickName?: string              // 不存储（可能包含敏感信息）
  // gender?: number                // 不存储（可能包含敏感信息）
  // description?: string           // 不存储（可能包含敏感信息）
}
```

**与 v1.0 差异**：
- ✅ **移除了敏感信息**：phoneNumber, email, username, role, roles
- ✅ **新增了机构信息**：institutionId, institutionName, domain
- ✅ **新增了用户类型**：userType, residentType

---

### 3. 机构信息（INSTITUTION_INFO_KEY）- 新增

```typescript
// 存储键名
INSTITUTION_INFO_KEY = 'INSTITUTION_INFO'

// 存储内容
interface InstitutionInfo {
  institutionId: string
  institutionName: string
  domain?: string
}
```

**v1.0 中没有**：v1.5 新增，用于跨机构登录和页面显示

---

### 4. 角色信息（ROLES_KEY）- 不存储

```typescript
// ❌ v1.5 不存储角色信息
// 如果需要角色信息，应该从服务器 API 获取（使用 token）
```

**与 v1.0 差异**：
- ❌ v1.0 存储了 `ROLES_KEY`
- ✅ v1.5 不存储角色信息（敏感信息）

---

## 对比总结

| 信息类型 | v1.0 存储 | v1.5 存储 | 原因 |
|---------|----------|----------|------|
| **Token** | ✅ | ✅ | 认证必需 |
| **Refresh Token** | ✅ | ✅ | 认证必需 |
| **用户 ID** | ✅ | ✅ | 非敏感，API 请求必需 |
| **用户类型** | ❌ | ✅ | 新增，权限控制必需 |
| **机构信息** | ❌ | ✅ | 新增，跨机构登录必需 |
| **用户名** | ✅ | ❌ | 敏感信息，HIPAA 合规 |
| **电话号码** | ✅ | ❌ | PHI，敏感信息，HIPAA 合规 |
| **邮箱** | ✅ | ❌ | PHI，敏感信息，HIPAA 合规 |
| **角色** | ✅ | ❌ | 权限信息，敏感 |
| **角色列表** | ✅ | ❌ | 权限信息，敏感 |
| **昵称** | ✅ | ❌ | 可能包含敏感信息 |
| **性别** | ✅ | ❌ | 可能包含敏感信息 |
| **描述** | ✅ | ❌ | 可能包含敏感信息 |

---

## v1.5 改进点

### 1. HIPAA 合规
- ✅ **移除 PHI 存储**：phoneNumber, email 等敏感信息不存储
- ✅ **移除权限信息存储**：role, roles 等权限信息不存储
- ✅ **仅存储非敏感信息**：userId, userType, institutionId 等

### 2. 新增功能支持
- ✅ **跨机构登录**：新增 institutionId, institutionName 存储
- ✅ **用户类型区分**：新增 userType, residentType 存储
- ✅ **Resident 类型区分**：支持 home/institution 两种类型

### 3. 安全增强
- ✅ **敏感信息从服务器获取**：如果需要显示 email, phone, role 等，应该从服务器 API 获取（使用 token）
- ✅ **不持久化敏感信息**：避免设备丢失或浏览器被攻击时泄露敏感信息

---

## 实现建议

### 1. 如果需要显示用户详细信息

**v1.0 方式**（不推荐）：
```typescript
// 直接从本地存储读取
const userInfo = userStore.getUserInfo()
console.log(userInfo.phoneNumber)  // ❌ 从本地存储读取敏感信息
```

**v1.5 方式**（推荐）：
```typescript
// 从服务器 API 获取（使用 token）
const userInfo = await getUserInfoApi()  // ✅ 从服务器获取
console.log(userInfo.phoneNumber)  // ✅ 仅在内存中，不持久化

// 如果需要临时存储（仅内存，不持久化）
const userDetailInfo = ref<UserDetailInfo | null>(null)
userDetailInfo.value = await getUserInfoApi()
```

### 2. 如果需要角色信息

**v1.0 方式**（不推荐）：
```typescript
// 直接从本地存储读取
const roles = userStore.getRoleList()  // ❌ 从本地存储读取权限信息
```

**v1.5 方式**（推荐）：
```typescript
// 从服务器 API 获取（使用 token）
const roles = await getRolesApi()  // ✅ 从服务器获取

// 如果需要临时存储（仅内存，不持久化）
const roleList = ref<RoleEnum[]>([])
roleList.value = await getRolesApi()
```

---

## 参考文件

### v1.0 相关文件
- `/Users/sady3721/project/wisefido-frontend/wisefido-platform-vue/src/store/modules/user.ts`
- `/Users/sady3721/project/wisefido-frontend/wisefido-platform-vue/src/utils/auth/index.ts`
- `/Users/sady3721/project/wisefido-frontend/wisefido-platform-vue/src/enums/cacheEnum.ts`
- `/Users/sady3721/project/wisefido-frontend/wisefido-platform-vue/types/store.d.ts`

### v1.5 相关文件
- `docs/store.md` - 状态管理设计（包含用户信息类型定义和存储策略）
- `docs/token.md` - Token 管理设计
- `src/api/auth/model/authModel.ts` - API 接口类型定义

